---
title: "Hardening VMs"
description: "Hardening virtual machines involves securing them against potential threats by reducing the 
attack surface and implementing security best practices. This includes updating the system, managing users, 
securing the network and file system, and configuring SSH and other services securely."
---


## Setting up
1. Navigate to the [Ubuntu Pro](https://ubuntu.com/pro) webpage and subscribe for Ubuntu Pro
2. Depending on your setup needs, you can get the subscription as an organization or for yourself. Signing up for
 a personal subscription will get you **5 machines** for you or any business you own, or **50 machines for active 
[Ubuntu Community members](https://ubuntu.com/community/membership).**
3. Once you've gotten a subscription and verified your Ubuntu Pro account, navigate to the 
[dashboard](https://ubuntu.com/pro/dashboard) page to view the token that you will use to activate your virtual machine.
![Ubuntu Pro Token](/images/ubuntu_pro_token.png)
4. Copy the command to attach to your virtual machine
```bash
sudo pro attach UBUNTU-PRO-TOKEN-HERE
```
5. After that command has executed successfully, you can check for available updates with the following command
```bash
sudo pro security-status
```


## Enable Livepatch for your system
The `Canonical Livepatch` patches high and critical Linux kernel vulnerabilities, removing the immediate need to reboot 
to upgrade the kernel, and instead allowing the downtime to be scheduled.
Canonical Livepatch is meant for critical infrastructure, where unscheduled downtime is to be avoided. By applying live 
kernel patches for high and critical kernel vulnerabilities, upgrades can be scheduled at a suitable time.

To enable livepatch for the virtual machine, proceed by executing the following command in the terminal:
```bash
sudo pro enable livepatch
```
The command above will install the livepatch client, and enroll the system to the Ubuntu livepatch service
You can start by checking the Livepatch status of the virtual machine 
```bash
canonical-livepatch status
```
This will produce output similar to this:
![livepatch-status-image](/images/livepatch-status-image.png)



## Enable CIS Compliance within your Ubuntu Virtual Machines
Ubuntu contains native tooling to automate compliance and auditing with the Center for Internet Security (CIS) benchmarks.
As these documents contain a large number of hardening rules, compliance and auditing can be very efficient when using the Ubuntu native tooling that is available in Ubuntu Pro.
We will use the Ubuntu Security Guide (USG) an easy to use tool for compliance and auditing that replaces our older tooling.

Depending on your version of Ubuntu installed in the VM, you can visit this official page for the respective instructions.
The following instructions assume you are using Ubuntu version 20.04 LTS or 22.04 LTS

### Step 1: Installation of Ubuntu Security Guide
```bash
sudo apt update
sudo apt install ubuntu-advantage-tools
```

### Step 2: Set up the Ubuntu Security Guide
```bash
sudo pro enable usg
sudo apt install usg
```

### Step 3: Applying the CIS rules to the system
Modifying a system to comply with the CIS benchmark with USG is as simple as the following command:
```text
sudo usg fix <PROFILE>
```
where profile is one of the following:
```
PROFILE NAME                    CORRESPONDING CIS PROFILE
------------------------------------------------------------
cis_level_1_workstation         Level 1 Workstation profile
____________________________________________________________
cis_level1_server	            Level 1 Server profile
____________________________________________________________
cis_level2_workstation	        Level 2 Workstation profile
____________________________________________________________
cis_level2_server	            Level 2 Server profile
____________________________________________________________
```
After applying the command, the system is modified to comply with the provided profile

### Step 4. Applying the CIS rules to a set of systems
It is not always practical to install the Ubuntu Security Guide to the systems that need to comply. For 
these systems you can generate a bash script that will apply the necessary changes. The following command 
generates that script.
```bash
sudo usg generate-fix <PROFILE> --output fix.sh
```

### Step 5: Customizing the CIS profile
Compliance with a benchmark is not an all-or-nothing task. Each environment is different and options that are 
considered as niche in one place can be essential in another. As such, USG allows to tailor the profile and remove 
unnecessary rules, as well as customize the rules that have multiple options available.

#### Setting variables
You can customize a profile using a `tailoring file`, as demonstrated below.
1. Generate a tailoring file.
```bash
sudo usg generate-tailoring cis_level1_server tailor.xml
```

2. Edit the tailoring file and go through the rules shown as comments. For example to update the threshold on \
lockouts for failed password attempts:
```xml
<!--5.4.2 Ensure lockout for failed password attempts is configured (Automated)-->
    <set-value idref="xccdf_org.ssgproject.content_value_var_accounts_passwords_pam_faillock_deny">4</set-value>
```
And replace the value 4 with the number of your choosing

3. Audit using the tailoring file with modifications. Or provide a tailoring file with your own customizations.
```bash
usg audit --tailoring-file your-modified-tailor-file.xml
```

4. Fix using the modified tailoring file.
```bash
usg fix --tailoring-file your-modified-tailor-file.xml
```

In case you want to disable/remove rules, visit the [official page](https://ubuntu.com/security/certifications/docs/usg/cis/customization) for more info.




### Referrence: 
1. [Ubuntu Pro official page](https://ubuntu.com/pro)
2. [Official Livepatch Documentation](https://ubuntu.com/security/livepatch/docs/livepatch) 
3. [CIS compliance with Ubuntu LTS](https://ubuntu.com/security/certifications/docs/usg/cis)